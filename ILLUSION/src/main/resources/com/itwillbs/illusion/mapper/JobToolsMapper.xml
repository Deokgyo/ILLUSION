<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
	
<mapper namespace="com.itwillbs.illusion.mapper.JobToolsMapper">
	
	<!-- 직무 대분류 값 가져오기  -->
	<select id="getOccupation">
		SELECT code, code_name
		  FROM common_code
		 WHERE code_group_id = 'OCCUPATION'
		   AND parent_code_id is null
	</select>
	
	<!--  직무 소분류 값 가져오기 -->
	<select id="getJobList">
		SELECT code, code_name
		  FROM common_code
		 WHERE code_group_id = 'occupation'	
		   AND parent_code_id = #{occupation};
	</select>
	
	<!-- 경력 가져오기 -->
	<select id="getExperience">
		SELECT code, code_name 
		  FROM common_code
		 WHERE code_group_id = "experience";
	</select>
	
	<!-- 자소서 저장하기 -->
	<insert id="saveCoverletter" 
			parameterType="map"
        	useGeneratedKeys="true"	 
        	keyProperty="cl_idx">
		INSERT INTO cover_letter
			(  member_idx
			 , cl_title
			 , company_name
			 , generated_cl_content
			 , generated_char_count
			 , generated_char_count_no_space
			 , cl_type)			  
	    VALUES (
		  	  #{member_idx}
		  	, #{title}
		  	, #{company}
		  	, #{aiResult}
		  	, #{generated_char_count}
		  	, #{generated_char_count_no_space}
		  	, #{cl_type} )
	</insert>
	
	<!-- 자소서 정보 가져오기 -->
	<select id="getCoverletterById">
	    SELECT 
	           cl_idx
	         , member_idx
	         , cl_title
	         , company_name
	         , generated_cl_content
	         , generated_char_count
	         , generated_char_count_no_space
	         , generation_date
	         , cl_type
	      FROM cover_letter
	     WHERE cl_idx = #{cl_idx}
	</select>
	
	<!-- 예상 질문 저장하기 -->
	<insert id="insertQuestion">
	    INSERT INTO question 
	         ( cl_idx
	         , member_idx
	         , question_text)
	    VALUES
	    <foreach collection="splitResult" item="q" separator=",">
	         ( #{cl_idx}
	         , #{member_idx}
	         , #{q})
	    </foreach>
	</insert>
	
	<!-- 특정 회원의 자소서 목록 조회 -->
	<select id="getCoverletterTitlesByMember">
		SELECT 
			   cl_idx
			,  cl_title
			,  company_name
		  FROM cover_letter c
		  JOIN member m ON m.member_idx = c.member_idx
		 WHERE m.member_idx = #{member_idx}
	</select>
	
	<!-- 자소서 저장 여부 토글 -->
	<update id="toggleSaveStatus">
	     UPDATE cover_letter
	        SET is_saved_to_mypage = 
   	       CASE 
   	       WHEN is_saved_to_mypage = 'BOL001' THEN 'BOL002' 
	       ELSE 'BOL001'                                   
	        END
     	  WHERE cl_idx = #{cl_idx}
	</update>
	
	<!-- 자소서 저장 여부 조회 -->
	<select id="selectSaveStatus">
   	     SELECT is_saved_to_mypage
   	       FROM cover_letter
   	      WHERE cl_idx = #{cl_idx}
	</select>
	
	<!-- 유저 토큰 수 조회 -->
	<select id="getMemberToken">
		SELECT token
		  FROM member
		 WHERE member_idx = #{member_idx}	
	</select>
	
	<!-- 회원 토큰 수 차감 -->
	<update id="deductToken">
		UPDATE member
		   SET token = token - #{tokenAmount}
		 WHERE member_idx = #{member_idx}
		   AND token >= #{tokenAmount}  
	</update>
	
	<!-- 예상면접 질문 생성한거 가져오기(덕교) -->
	<select id="selectInterviewResult">
		SELECT question_idx
			 , cl_idx
			 , question_text
			 , member_idx
		  FROM question
		 WHERE cl_idx = #{cl_idx} 
	</select>
	
</mapper>