<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
	
<mapper namespace="com.itwillbs.illusion.mapper.JobToolsMapper">
	
	<!-- 직무 대분류 값 가져오기  -->
	<select id="getOccupation">
		SELECT code, code_name
		  FROM common_code
		 WHERE code_group_id = 'OCCUPATION'
		   AND parent_code_id is null
	</select>
	
	<!--  직무 소분류 값 가져오기 -->
	<select id="getJobList">
		SELECT code, code_name
		  FROM common_code
		 WHERE code_group_id = 'occupation'	
		   AND parent_code_id = #{occupation};
	</select>
	
	<!-- 경력 가져오기 -->
	<select id="getExperience">
		SELECT code, code_name 
		  FROM common_code
		 WHERE code_group_id = "experience";
	</select>
	
	<!-- 자소서 저장하기 -->
	<insert id="saveCoverletter" 
			parameterType="map"
        	useGeneratedKeys="true"	 
        	keyProperty="cl_idx">
		INSERT INTO cover_letter
			(  member_idx
			 , cl_title
			 , company_name
			 , generated_cl_content
			 , generated_char_count
			 , generated_char_count_no_space
			 , cl_type
			 , original_cl_idx
			 )			  
	    VALUES (
		  	  #{member_idx}
		  	, #{title}
		  	, #{company}
		  	, #{aiResult}
		  	, #{generated_char_count}
		  	, #{generated_char_count_no_space}
		  	, #{cl_type}
		  	, #{original_cl_idx} 
		  	)
	</insert>
	
	<!-- 자소서 정보 가져오기 -->
	<select id="getCoverletterById">
	    SELECT 
	           cl_idx
	         , member_idx
	         , cl_title
	         , company_name
	         , generated_cl_content
	         , generated_char_count
	         , generated_char_count_no_space
	         , generation_date
	         , cl_type
	      FROM cover_letter
	     WHERE cl_idx = #{cl_idx}
	</select>
	
	<!-- 예상 질문 저장하기 -->
	<insert id="insertQuestion">
	    INSERT INTO question 
	         ( cl_idx
	         , member_idx
	         , question_text)
	    VALUES
	    <foreach collection="splitResult" item="q" separator=",">
	         ( #{cl_idx}
	         , #{member_idx}
	         , #{q})
	    </foreach>
	</insert>
	
	<!-- 특정 회원의 자소서 목록 조회 -->
	<select id="getCoverletterTitlesByMember">
		SELECT 
			   cl_idx
			,  cl_title
			,  company_name
			,  original_cl_idx
		  FROM cover_letter c
		  JOIN member m ON m.member_idx = c.member_idx
		 WHERE m.member_idx = #{member_idx}
		   AND cl_type != 'CL003'
	</select>
	
	<!-- 자소서 저장 여부 토글 및 상태 조회 (프로시저 호출) -->
	<!-- 프로시저 조회 SHOW CREATE PROCEDURE sp_toggle_and_select_save_status; -->
	<select id="callToggleAndSelectSaveStatus" resultType="java.util.HashMap" statementType="CALLABLE">
	    {CALL sp_toggle_and_select_save_status(#{cl_idx, mode=IN})}
	</select>
	
	<!-- 유저 토큰 수 조회 -->
	<select id="getMemberToken">
		SELECT token
		  FROM member
		 WHERE member_idx = #{member_idx}	
	</select>
	
	<!-- 회원 토큰 수 차감 -->
	<update id="deductToken">
		UPDATE member
		   SET token = token - #{tokenAmount}
		 WHERE member_idx = #{member_idx}
		   AND token >= #{tokenAmount}  
	</update>
	
	<!-- 예상면접 질문 생성한거 가져오기(덕교) -->
	<select id="selectInterviewResult">
		SELECT question_idx
			 , cl_idx
			 , question_text
			 , member_idx
		  FROM question
		 WHERE cl_idx = #{cl_idx} 
	</select>
	
	<!-- 예상 면접 질문 답변한거 피드백 저장(덕교) -->
	<insert id="insertAnswer">
		INSERT INTO answer 
	  		 ( question_idx 
       		 , member_idx
      		 , answer_text
       		 , ai_feedback )
  	    VALUES ( 
  	    	   #{question_idx}
	   		 , #{member_idx}
       		 , #{answer_text}
      		 , #{ai_feedback}
       		 )
	</insert>
	
</mapper>